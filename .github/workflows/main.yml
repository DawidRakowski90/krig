name: Create new project from template

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: "Service Name"
        required: true
      endpoint:
        description: "main endpoint (f.e. /test)"
        required: true
      secrets:
        description: "Secrets ',' separated"
        required: true

jobs:
  scaffold:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout template repo
        uses: actions/checkout@v4

      - name: Create project structure
        run: |
          SERVICE=${{ inputs.service_name }}
          ENDPOINT=${{ inputs.endpoint }}
          SECRETS=${{ secrets }}

          mkdir -p GCRUN/$SERVICE

          # main app
          cat > GCRUN/$SERVICE/Dockerfile << EOF
          FROM node:22-slim
          WORKDIR /app/ai-api
          COPY GCRun/ai-api/package*.json ./
          RUN npm ci --omit=dev
          COPY GCRun/ai-api ./
          COPY GCRun/libs ./libs
          ENV PORT=8080
          EXPOSE 8080
          CMD ["node", "server.js"]
          
          EOF

          # package.json
          cat > GCRUN/$SERVICE/package.json << EOF
          {
            "name": $SERVICE,
            "version": "1.0.0",
            "type": "module",
            "main": "server.js",
            "scripts": {
              "start": "node server.js"
            },
            "dependencies": {
              "express": "^5.1.0",
              "firebase-admin": "^13.4.0",
              "google-auth-library": "^10.1.0",
              "moment-timezone": "^0.6.0",
              "protobufjs": "^7.5.3"
              }
          }
          EOF

          # secrets
          cat > GCRUN/$SERVICE/secrets << EOF
            $SECRETS
          EOF

          # server file
          cat > GCRUN/$SERVICE/server.js << EOF
          // server.js  â€“ Cloud Run entry-point
          import express from 'express';

          const app = express();
          app.use(express.json());

          app.post('$ENDPOINT', async (req, res) => {
            try { res.status(200).send('OK) }
            catch (err) { res.status(500).send(err.message) }
          })

          app.listen(process.env.PORT || 8080);

          
          # Readme
          cat > GCRUN/$SERVICE/README.md << EOF
          # $SERVICE
          
          Auto-generated project.
          ## Module
          $MODULE

          ## Port
          $PORT

          ## Database
          $DB
          EOF

      - name: Commit generated project
        run: |
          git config user.name "GitHub Bot"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Scaffold project ${{ inputs.service_name }}"
          git push
