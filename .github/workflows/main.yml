name: Create new project from template

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: "Service Name"
        required: true
      endpoint:
        description: "Main endpoint (e.g. /test)"
        required: true
      secrets:
        description: "Secrets ',' separated"
        required: true

jobs:
  scaffold:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate service
        run: |
          SERVICE="${{ inputs.service_name }}"
          ENDPOINT="${{ inputs.endpoint }}"
          SECRETS="${{ inputs.secrets }}"

          mkdir -p GCRUN/$SERVICE
          # package.json
          cat > GCRUN/$SERVICE/package.json << EOF
          {
            "name": "$SERVICE",
            "version": "1.0.0",
            "type": "module",
            "main": "server.js",
            "scripts": {
              "start": "node server.js"
            },
            "dependencies": {
              "express": "^5.1.0"
            }
          }
          EOF
          # Dockerfile
          cat > GCRUN/$SERVICE/Dockerfile << EOF
          FROM node:22-slim
          WORKDIR /app/$SERVICE
          COPY GCRun/$SERVICE/package*.json ./
          RUN npm ci --omit=dev
          COPY GCRun/$SERVICE ./
          COPY GCRun/libs ./libs
          ENV PORT=8080
          EXPOSE 8080
          CMD ["node", "server.js"]
          EOF

          

          # secrets
          echo "$SECRETS" > GCRUN/$SERVICE/secrets.txt

          # server.js
          cat > GCRUN/$SERVICE/server.js << EOF
          import express from "express";

          const app = express();
          app.use(express.json());

          app.post("$ENDPOINT", async (req, res) => {
            try {
              res.status(200).send("OK");
            } catch (err) {
              res.status(500).send(err.message);
            }
          });

          app.listen(process.env.PORT || 8080, () => {
            console.log("Service $SERVICE running");
          });
          EOF

          # README
          cat > GCRUN/$SERVICE/README.md << EOF
          # $SERVICE

          Auto-generated Cloud Run service.

          ## Endpoint
          $ENDPOINT

          ## Secrets
          $SECRETS
          EOF

      - name: Commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Scaffold ${{ inputs.service_name }}"
          git push
